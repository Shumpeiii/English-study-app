<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è‹±å˜èªãƒœãƒ¼ãƒ‰ï¼ˆLvï¼‹è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‹ã‚ªãƒ¼ãƒˆé–¢é€£ï¼‰</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#fff; --text:#111; --sub:#666;
    --border:#e6e6e9; --accent:#0f172a; --danger:#a20000;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text);}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px); background:rgba(255,255,255,.85); border-bottom:1px solid var(--border);}
  .container{max-width:980px; margin:0 auto; padding:12px 16px;}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .title{font-weight:700}
  .grow{flex:1 1 auto}

  /* å…¥åŠ›ç³»ã¨ãƒœã‚¿ãƒ³ã«å½±ï¼‹ãƒ›ãƒãƒ¼/ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®â€œæŠ¼ã—ãŸæ„Ÿâ€ */
  input[type="text"], select, textarea{
    width:100%; padding:10px 12px;
    border:1px solid var(--border);
    border-radius:12px;
    background:#fff;
    box-shadow:0 2px 4px rgba(0,0,0,.08);
    transition:box-shadow .2s ease, transform .08s ease, background-color .08s ease;
  }
  input[type="text"]:hover, select:hover, textarea:hover{
    box-shadow:0 3px 6px rgba(0,0,0,.12);
  }
  input[type="text"]:focus, select:focus, textarea:focus{
    outline:none; box-shadow:0 0 0 3px rgba(15,23,42,.12), 0 3px 6px rgba(0,0,0,.14);
  }

  button, .btn{
    border:1px solid var(--border);
    background:#fff;
    padding:9px 12px;
    border-radius:12px;
    cursor:pointer;
    box-shadow:0 2px 4px rgba(0,0,0,.08);
    transition:box-shadow .2s ease, transform .08s ease, background-color .08s ease;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
  }
  button:hover, .btn:hover{
    box-shadow:0 3px 6px rgba(0,0,0,.12);
  }
  /* ã‚¿ãƒƒãƒ—æ™‚ã®æŠ¼ã—è¾¼ã¿ï¼ˆã‚¹ãƒãƒ›ã§ã‚‚åŠ¹ãï¼‰ */
  button:active, .btn:active{
    transform: translateY(1px) scale(0.98);
    box-shadow:0 1px 2px rgba(0,0,0,.06);
    background:#f0f0f0;
  }
  /* ãƒ¢ãƒã‚¤ãƒ«ã§ãƒ›ãƒãƒ¼ãªã—ç’°å¢ƒã®æœ€é©åŒ–ï¼ˆæŠ¼ã—ãŸæ™‚ã®å¤‰åŒ–ã‚’å¼·èª¿ï¼‰ */
  @media (hover: none){
    button:active, .btn:active{
      transform: translateY(1px) scale(0.985);
    }
  }

  .btn-accent{background:var(--accent); color:#fff; border-color:var(--accent)}
  .btn-accent:hover{box-shadow:0 4px 8px rgba(15,23,42,.24)}
  .btn-accent:active{background:#0c142d}

  .btn-danger{border-color:#f1c5c5; color:var(--danger); background:#fff5f5}
  .btn-danger:hover{box-shadow:0 3px 6px rgba(162,0,0,.18)}
  .btn-danger:active{background:#ffeaea}

  .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--sub); background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.05)}
  main{padding:16px}
  .level-box{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden;}
  .level-head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:#fff;}
  .list{max-height:70vh; overflow:auto; padding:8px 8px 12px}
  .card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; margin:8px 2px; box-shadow:0 1px 0 rgba(0,0,0,.03);}
  .term{font-weight:700}
  .mean{color:var(--sub); font-size:13px}
  .tag{display:inline-block; font-size:11px; padding:2px 6px; margin:4px 6px 0 0; border-radius:999px; border:1px solid var(--border); color:#444; background:#fafafa; box-shadow:0 1px 2px rgba(0,0,0,.05)}
  .empty{color:#999; text-align:center; padding:20px}
  dialog{border:none; border-radius:16px; width:min(600px, 92vw); padding:0; box-shadow:0 20px 60px rgba(0,0,0,.25); background:#fff}
  .modal-body{padding:16px}
  .modal-foot{display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--border); background:#fafafa; border-radius:0 0 16px 16px}
  .field{margin:10px 0}
  label{display:block; font-size:12px; color:#666; margin:6px 0}
  .toolbar{display:flex; flex-wrap:wrap; gap:8px}
  .muted{color:#777; font-size:12px}
</style>
</head>
<body>
<header>
  <div class="container row">
    <div class="title">è‹±å˜èªãƒœãƒ¼ãƒ‰</div>
    <div class="grow"></div>

    <!-- ãƒ¬ãƒ™ãƒ«é¸æŠ -->
    <select id="levelSelect" style="min-width:110px"></select>

    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼çµã‚Šè¾¼ã¿ -->
    <select id="catFilter" title="ã‚«ãƒ†ã‚´ãƒªãƒ¼" style="min-width:160px"></select>
    <button id="manageCatsBtn" title="ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†">ã‚«ãƒ†ã‚´ãƒªç®¡ç†</button>

    <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
    <select id="viewMode" title="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰" style="min-width:125px">
      <option value="en">è‹±èªã®ã¿</option>
      <option value="ja">æ—¥æœ¬èªã®ã¿</option>
      <option value="both">ä¸¡æ–¹</option>
    </select>

    <input id="search" type="text" placeholder="æ¤œç´¢ï¼ˆè‹±èª / æ—¥æœ¬èª / ã‚«ãƒ†ã‚´ãƒªãƒ¼åï¼‰" />
    <button id="addWordBtn" class="btn-accent">ï¼‹ è¿½åŠ </button>
    <button id="manageLevelsBtn">ãƒ¬ãƒ™ãƒ«ç®¡ç†</button>
    <button id="exportBtn">æ›¸ãå‡ºã—</button>
    <label class="btn">
      èª­ã¿è¾¼ã¿<input id="importInput" type="file" accept="application/json" hidden />
    </label>
    <button id="resetBtn" class="btn-danger">å…¨æ¶ˆå»</button>
  </div>
</header>

<main class="container">
  <section class="level-box">
    <div class="level-head">
      <div id="levelTitle" class="title">Lv</div>
      <div class="grow"></div>
      <span id="countPill" class="pill"></span>
    </div>
    <div id="list" class="list"></div>
  </section>
  <div class="muted" style="margin-top:10px;">
    å˜èªã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ï¼ˆæ„å‘³ãƒ»ä¾‹æ–‡ãƒ»ç™ºéŸ³ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ãƒ¬ãƒ™ãƒ«/ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´ãƒ»é–¢é€£èªï¼‰ã€‚
  </div>
</main>

<!-- è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="wordDlg">
  <form method="dialog">
    <div class="modal-body">
      <h3 id="wordDlgTitle" style="margin:4px 0 8px 0">å˜èªã‚’è¿½åŠ </h3>
      <div class="field">
        <label>è‹±å˜èª / ç†Ÿèª</label>
        <input id="fTerm" type="text" required />
      </div>
      <div class="field">
        <label>æ—¥æœ¬èªã®æ„å‘³</label>
        <input id="fMeaning" type="text" required />
      </div>
      <div class="field">
        <label>ä¾‹æ–‡ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="fExample" placeholder="ä¾‹ï¼‰I had an apple for breakfast."></textarea>
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 40%">
          <label>ãƒ¬ãƒ™ãƒ«</label>
          <select id="fLevel"></select>
        </div>
        <div class="field" style="flex:1 1 60%">
          <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <select id="fCats" multiple size="6" title="Ctrl/âŒ˜ã§è¤‡æ•°é¸æŠ"></select>
        </div>
      </div>
      <div class="muted">åŒä¸€ãƒ¬ãƒ™ãƒ«å†…ã§åŒã˜è‹±å˜èªã®é‡è¤‡ã‚’é˜²æ­¢ã—ã¾ã™ã€‚</div>
    </div>
    <div class="modal-foot">
      <button class="btn-accent">ä¿å­˜</button>
      <button type="button" id="wordDlgCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </form>
</dialog>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="detailDlg">
  <div class="modal-body">
    <div class="toolbar">
      <span id="dTerm" class="title" style="font-size:20px"></span>
      <button id="speakBtn" title="ç™ºéŸ³">ğŸ”Š</button>
      <span class="pill" id="dLevelPill"></span>
    </div>
    <div style="margin-top:6px">
      <div><strong>æ„å‘³ï¼š</strong><span id="dMeaning"></span></div>
      <div id="dExampleWrap" style="margin-top:6px; display:none;"><strong>ä¾‹æ–‡ï¼š</strong><div id="dExample" style="white-space:pre-wrap"></div></div>
      <div style="margin-top:8px;"><strong>ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼š</strong><span id="dCats"></span></div>
      <div style="margin-top:8px;">
        <strong>é–¢é€£èªï¼ˆè‡ªå‹•ï¼‰ï¼š</strong>
        <div id="dRelated" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px"></div>
        <div class="muted" style="margin-top:4px">â€» èªå¹¹ãƒ»å‰æ–¹ä¸€è‡´ã«åŸºã¥ãè‡ªå‹•ç”Ÿæˆï¼ˆLIKE â†’ ALIKE / LIKELY / LIKABLE ãªã©ï¼‰</div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="field" style="flex:1 1 40%">
        <label>ãƒ¬ãƒ™ãƒ«å¤‰æ›´</label>
        <select id="dLevelSel"></select>
      </div>
      <div class="field" style="flex:1 1 60%">
        <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´ï¼ˆè¤‡æ•°é¸æŠï¼‰</label>
        <select id="dCatsSel" multiple size="6"></select>
      </div>
    </div>

    <div class="toolbar" style="margin-top:8px">
      <button id="editBtn">ç·¨é›†</button>
      <button id="deleteBtn" class="btn-danger">å‰Šé™¤</button>
      <div class="grow"></div>
      <button id="detailClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</dialog>

<!-- ãƒ¬ãƒ™ãƒ«ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="levelsDlg">
  <form method="dialog">
    <div class="modal-body">
      <h3 style="margin:4px 0 8px 0">ãƒ¬ãƒ™ãƒ«ç®¡ç†</h3>
      <div id="levelsList"></div>
      <div class="row" style="margin-top:10px">
        <input id="newLevelName" type="text" placeholder="æ–°ã—ã„ãƒ¬ãƒ™ãƒ«åï¼ˆä¾‹ï¼šLv5ï¼‰" />
        <button type="button" id="addLevelReal">ï¼‹ è¿½åŠ </button>
      </div>
      <div class="muted" style="margin-top:8px">ãƒ¬ãƒ™ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ãã®ãƒ¬ãƒ™ãƒ«ã®å˜èªã¯å…ˆé ­ãƒ¬ãƒ™ãƒ«ã¸ç§»å‹•ã—ã¾ã™ã€‚</div>
    </div>
    <div class="modal-foot">
      <button class="btn-accent">é–‰ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="catsDlg">
  <form method="dialog">
    <div class="modal-body">
      <h3 style="margin:4px 0 8px 0">ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç†</h3>
      <div id="catsList"></div>
      <div class="row" style="margin-top:10px">
        <input id="newCatName" type="text" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼åï¼ˆä¾‹ï¼šã‚¤ãƒ‡ã‚£ã‚ªãƒ ï¼‰" />
        <button type="button" id="addCatReal">ï¼‹ è¿½åŠ </button>
      </div>
      <div class="muted" style="margin-top:8px">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€å„å˜èªã‹ã‚‰å½“è©²ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒå¤–ã‚Œã¾ã™ï¼ˆæœªåˆ†é¡ãŒè‡ªå‹•ä»˜ä¸ï¼‰ã€‚</div>
    </div>
    <div class="modal-foot">
      <button class="btn-accent">é–‰ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<script>
/*** ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ***/
const LS_KEY = "vocab_board_v5_auto_related_shadow_touch";
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch{ return null; } }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

/*** çŠ¶æ…‹ ***/
let state = loadState() || {
  levels: ["Lv1","Lv2","Lv3","Lv4"],
  categories: ["æœªåˆ†é¡","åè©","å‹•è©","å½¢å®¹è©","å‰¯è©","ã‚¤ãƒ‡ã‚£ã‚ªãƒ "],
  words: [], // {id, term, meaning, example?, levelName, categories:[], relatedIds:[], createdAt}
  ui: { selectedLevel: "Lv1", viewMode: "both", catFilter: "__all", autoRelate: true }
};
// äº’æ›
(state.words||[]).forEach(w=>{
  if(!Array.isArray(w.categories)) w.categories=["æœªåˆ†é¡"];
  if(!Array.isArray(w.relatedIds)) w.relatedIds=[];
});
if(!state.ui) state.ui = { selectedLevel: state.levels?.[0]||"Lv1", viewMode:"both", catFilter:"__all", autoRelate:true };

const byId = (id)=> state.words.find(w=>w.id===id);

/*** å‚ç…§ ***/
const $levelSelect = document.getElementById("levelSelect");
const $catFilter = document.getElementById("catFilter");
const $viewMode = document.getElementById("viewMode");
const $levelTitle = document.getElementById("levelTitle");
const $countPill = document.getElementById("countPill");
const $list = document.getElementById("list");

const $search = document.getElementById("search");
const $addWordBtn = document.getElementById("addWordBtn");
const $manageLevelsBtn = document.getElementById("manageLevelsBtn");
const $manageCatsBtn = document.getElementById("manageCatsBtn");
const $exportBtn = document.getElementById("exportBtn");
const $importInput = document.getElementById("importInput");
const $resetBtn = document.getElementById("resetBtn");

/*** åˆæœŸåŒ–ï¼ˆUIåæ˜ ï¼‰ ***/
function initSelectors(){
  // level select
  $levelSelect.innerHTML = "";
  state.levels.forEach(lv=>{
    const opt = document.createElement("option");
    opt.value = lv; opt.textContent = lv;
    $levelSelect.appendChild(opt);
  });
  if(!state.levels.includes(state.ui.selectedLevel)) state.ui.selectedLevel = state.levels[0];
  $levelSelect.value = state.ui.selectedLevel;

  // category filter
  $catFilter.innerHTML = "";
  const allOpt = document.createElement("option");
  allOpt.value = "__all"; allOpt.textContent = "ã‚«ãƒ†ã‚´ãƒªãƒ¼: ã™ã¹ã¦";
  $catFilter.appendChild(allOpt);
  state.categories.forEach(cat=>{
    const o = document.createElement("option");
    o.value = cat; o.textContent = `ã‚«ãƒ†ã‚´ãƒªãƒ¼: ${cat}`;
    $catFilter.appendChild(o);
  });
  if(state.ui.catFilter!=="__all" && !state.categories.includes(state.ui.catFilter)){
    state.ui.catFilter = "__all";
  }
  $catFilter.value = state.ui.catFilter;

  // view mode
  $viewMode.value = state.ui.viewMode || "both";
}

/*** æç”» ***/
function render(){
  initSelectors();
  const lv = state.ui.selectedLevel;
  const mode = state.ui.viewMode;
  const cat = state.ui.catFilter;
  const q = $search.value.trim().toLowerCase();

  $levelTitle.textContent = lv + (cat!=="__all" ? `ï½œ${cat}` : "");

  let items = state.words
    .filter(w=>w.levelName===lv)
    .filter(w=> (cat==="__all") ? true : (w.categories||[]).includes(cat))
    .filter(w=>{
      if(!q) return true;
      return w.term.toLowerCase().includes(q)
          || (w.meaning||"").toLowerCase().includes(q)
          || (w.categories||[]).some(c=>c.toLowerCase().includes(q));
    })
    .sort((a,b)=> b.createdAt - a.createdAt);

  $countPill.textContent = `${items.length}èª`;

  $list.innerHTML = "";
  if(items.length===0){
    const empty = document.createElement("div");
    empty.className = "empty";
    empty.textContent = "å˜èªãŒã‚ã‚Šã¾ã›ã‚“";
    $list.appendChild(empty);
  }else{
    for(const w of items){
      const card = document.createElement("div");
      card.className = "card";
      let inner = "";
      if(mode==="en"){
        inner = `<div class="term">${escapeHtml(w.term)}</div>`;
      }else if(mode==="ja"){
        inner = `<div class="term">${escapeHtml(w.meaning)}</div>`;
      }else{
        inner = `<div class="term">${escapeHtml(w.term)}</div><div class="mean">${escapeHtml(w.meaning)}</div>`;
      }
      const tags = (w.categories||[]).map(c=>`<span class="tag">${escapeHtml(c)}</span>`).join("");
      card.innerHTML = inner + (tags? `<div>${tags}</div>`:"");
      card.addEventListener("click", ()=> openDetail(w.id));
      $list.appendChild(card);
    }
  }

  saveState();
}

function escapeHtml(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])) }

/*** è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ***/
const wordDlg = document.getElementById("wordDlg");
const wordDlgTitle = document.getElementById("wordDlgTitle");
const fTerm = document.getElementById("fTerm");
const fMeaning = document.getElementById("fMeaning");
const fExample = document.getElementById("fExample");
const fLevel = document.getElementById("fLevel");
const fCats = document.getElementById("fCats");
const wordDlgCancel = document.getElementById("wordDlgCancel");
let editingId = null;

function populateLevelOptions(sel){
  sel.innerHTML = "";
  state.levels.forEach(lv=>{
    const opt = document.createElement("option");
    opt.value = lv; opt.textContent = lv;
    sel.appendChild(opt);
  });
}
function populateCategoryOptions(sel, selected=[]){
  sel.innerHTML = "";
  state.categories.forEach(cat=>{
    const opt = document.createElement("option");
    opt.value = cat; opt.textContent = cat;
    if(selected.includes(cat)) opt.selected = true;
    sel.appendChild(opt);
  });
}

function openAdd(){
  wordDlgTitle.textContent = "å˜èªã‚’è¿½åŠ ";
  populateLevelOptions(fLevel);
  populateCategoryOptions(fCats, ["æœªåˆ†é¡"]);
  fTerm.value = ""; fMeaning.value = ""; fExample.value = "";
  fLevel.value = state.ui.selectedLevel || state.levels[0] || "Lv1";
  editingId = null;
  wordDlg.showModal(); setTimeout(()=>fTerm.focus(),50);
}
function openEdit(id){
  const w = byId(id); if(!w) return;
  wordDlgTitle.textContent = "å˜èªã‚’ç·¨é›†";
  populateLevelOptions(fLevel);
  populateCategoryOptions(fCats, w.categories||[]);
  fTerm.value = w.term; fMeaning.value = w.meaning || ""; fExample.value = w.example || "";
  fLevel.value = w.levelName;
  editingId = id;
  wordDlg.showModal();
}

function existsDuplicate(term, levelName, exceptId){
  const t = term.trim().toLowerCase();
  return state.words.some(w => w.levelName===levelName && w.term.trim().toLowerCase()===t && w.id!==exceptId);
}

wordDlg.addEventListener("close", ()=>{
  if(wordDlg.returnValue==="cancel") return;
  const term = fTerm.value.trim();
  const meaning = fMeaning.value.trim();
  if(!term || !meaning) return;
  const example = fExample.value.trim();
  const levelName = fLevel.value;
  const cats = Array.from(fCats.selectedOptions).map(o=>o.value);
  const categories = cats.length? cats : ["æœªåˆ†é¡"];

  if(existsDuplicate(term, levelName, editingId)){
    alert(`ã“ã®ãƒ¬ãƒ™ãƒ«ï¼ˆ${levelName}ï¼‰ã«ã¯ã™ã§ã«ã€Œ${term}ã€ãŒå­˜åœ¨ã—ã¾ã™ã€‚`);
    return;
  }

  if(editingId){
    Object.assign(byId(editingId), {term, meaning, example: example || undefined, levelName, categories});
  }else{
    state.words.unshift({ id: crypto.randomUUID(), term, meaning, example: example || undefined, levelName, categories, relatedIds:[], createdAt: Date.now() });
  }
  autoRelateAll();
  render();
});
wordDlgCancel.addEventListener("click", ()=>{ wordDlg.returnValue="cancel"; wordDlg.close(); });

/*** è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ***/
const detailDlg = document.getElementById("detailDlg");
const dTerm = document.getElementById("dTerm");
const dMeaning = document.getElementById("dMeaning");
const dExampleWrap = document.getElementById("dExampleWrap");
const dExample = document.getElementById("dExample");
const dLevelPill = document.getElementById("dLevelPill");
const dLevelSel = document.getElementById("dLevelSel");
const dCats = document.getElementById("dCats");
const dCatsSel = document.getElementById("dCatsSel");
const deleteBtn = document.getElementById("deleteBtn");
const editBtn = document.getElementById("editBtn");
const detailClose = document.getElementById("detailClose");
const speakBtn = document.getElementById("speakBtn");
const dRelated = document.getElementById("dRelated");
let currentDetailId = null;

function openDetail(id){
  const w = byId(id); if(!w) return;
  currentDetailId = id;
  dTerm.textContent = w.term;
  dMeaning.textContent = w.meaning || "";
  if(w.example){ dExampleWrap.style.display="block"; dExample.textContent = w.example; } else { dExampleWrap.style.display="none"; }
  dLevelPill.textContent = w.levelName;
  populateLevelOptions(dLevelSel); dLevelSel.value = w.levelName;
  dCats.innerHTML = (w.categories||[]).map(c=>`<span class="tag">${escapeHtml(c)}</span>`).join("");
  populateCategoryOptions(dCatsSel, w.categories||[]);
  renderRelatedChips(w);
  detailDlg.showModal();
}
function renderRelatedChips(w){
  dRelated.innerHTML = "";
  const ids = w.relatedIds||[];
  if(ids.length===0){
    const span = document.createElement("span");
    span.className = "muted";
    span.textContent = "ï¼ˆãªã—ï¼‰";
    dRelated.appendChild(span);
    return;
  }
  ids.forEach(id=>{
    const rw = byId(id); if(!rw) return;
    const btn = document.createElement("button");
    btn.className = "pill";
    btn.type = "button";
    btn.textContent = rw.term;
    btn.title = rw.meaning || "";
    btn.addEventListener("click", ()=> openDetail(rw.id));
    dRelated.appendChild(btn);
  });
}
dLevelSel.addEventListener("change", ()=>{
  const w = byId(currentDetailId); if(!w) return;
  w.levelName = dLevelSel.value;
  dLevelPill.textContent = w.levelName;
  state.ui.selectedLevel = w.levelName;
  autoRelateAll();
  render();
});
dCatsSel.addEventListener("change", ()=>{
  const w = byId(currentDetailId); if(!w) return;
  const cats = Array.from(dCatsSel.selectedOptions).map(o=>o.value);
  w.categories = cats.length? cats : ["æœªåˆ†é¡"];
  dCats.innerHTML = w.categories.map(c=>`<span class="tag">${escapeHtml(c)}</span>`).join("");
  saveState();
});
deleteBtn.addEventListener("click", ()=>{
  const w = byId(currentDetailId); if(!w) return;
  if(confirm(`ã€Œ${w.term}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){
    state.words = state.words.filter(x=>x.id!==w.id);
    autoRelateAll();
    detailDlg.close(); render();
  }
});
editBtn.addEventListener("click", ()=>{
  const id = currentDetailId; detailDlg.close(); setTimeout(()=>openEdit(id),50);
});
detailClose.addEventListener("click", ()=> detailDlg.close());
speakBtn.addEventListener("click", ()=>{
  const w = byId(currentDetailId); if(!w) return;
  speak(w.term);
});

/*** ãƒ¬ãƒ™ãƒ«ç®¡ç† ***/
const levelsDlg = document.getElementById("levelsDlg");
const levelsList = document.getElementById("levelsList");
const newLevelName = document.getElementById("newLevelName");
const addLevelReal = document.getElementById("addLevelReal");

function openLevels(){ renderLevelsList(); levelsDlg.showModal(); }
function renderLevelsList(){
  levelsList.innerHTML = "";
  state.levels.forEach((lv, idx)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.style.margin = "8px 0";
    row.innerHTML = `
      <input type="text" value="${escapeHtml(lv)}" data-idx="${idx}" style="flex:1 1 auto" />
      <button data-up="${idx}">â†‘</button>
      <button data-down="${idx}">â†“</button>
      <button class="btn-danger" data-del="${idx}">å‰Šé™¤</button>
    `;
    levelsList.appendChild(row);
  });

  levelsList.querySelectorAll("input[type=text]").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const i = +inp.dataset.idx;
      const old = state.levels[i];
      const name = inp.value.trim() || old;
      state.words.forEach(w=>{ if(w.levelName===old) w.levelName = name; });
      state.levels[i] = name;
      if(state.ui.selectedLevel===old) state.ui.selectedLevel = name;
      autoRelateAll();
      render(); renderLevelsList();
    });
  });
  levelsList.querySelectorAll("[data-up]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.up; if(i<=0) return;
      [state.levels[i-1], state.levels[i]] = [state.levels[i], state.levels[i-1]];
      render(); renderLevelsList();
    };
  });
  levelsList.querySelectorAll("[data-down]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.down; if(i>=state.levels.length-1) return;
      [state.levels[i+1], state.levels[i]] = [state.levels[i], state.levels[i+1]];
      render(); renderLevelsList();
    };
  });
  levelsList.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.del;
      if(state.levels.length<=1){ alert("ãƒ¬ãƒ™ãƒ«ã¯æœ€ä½1ã¤å¿…è¦ã§ã™"); return; }
      const delName = state.levels[i];
      if(!confirm(`ãƒ¬ãƒ™ãƒ«ã€Œ${delName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãã®ãƒ¬ãƒ™ãƒ«ã®å˜èªã¯å…ˆé ­ãƒ¬ãƒ™ãƒ«ã¸ç§»å‹•ã—ã¾ã™ã€‚`)) return;
      const fallback = state.levels[0 === i ? 1 : 0];
      state.words.forEach(w=>{ if(w.levelName===delName) w.levelName = fallback; });
      if(state.ui.selectedLevel===delName) state.ui.selectedLevel = fallback;
      state.levels.splice(i,1);
      autoRelateAll();
      render(); renderLevelsList();
    };
  });
}
addLevelReal.addEventListener("click", ()=>{
  const name = newLevelName.value.trim();
  if(!name) return;
  if(state.levels.includes(name)){ alert("åŒåãƒ¬ãƒ™ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"); return; }
  state.levels.push(name);
  newLevelName.value="";
  render(); renderLevelsList();
});

/*** ã‚«ãƒ†ã‚´ãƒªãƒ¼ç®¡ç† ***/
const catsDlg = document.getElementById("catsDlg");
const catsList = document.getElementById("catsList");
const newCatName = document.getElementById("newCatName");
const addCatReal = document.getElementById("addCatReal");

function openCats(){ renderCatsList(); catsDlg.showModal(); }
function renderCatsList(){
  catsList.innerHTML = "";
  state.categories.forEach((cat, idx)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.style.margin = "8px 0";
    row.innerHTML = `
      <input type="text" value="${escapeHtml(cat)}" data-idx="${idx}" style="flex:1 1 auto" />
      <button data-up="${idx}">â†‘</button>
      <button data-down="${idx}">â†“</button>
      <button class="btn-danger" data-del="${idx}">å‰Šé™¤</button>
    `;
    catsList.appendChild(row);
  });

  // å¤‰æ›´
  catsList.querySelectorAll("input[type=text]").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const i = +inp.dataset.idx;
      const old = state.categories[i];
      const name = inp.value.trim() || old;
      state.words.forEach(w=>{
        if(Array.isArray(w.categories)){
          w.categories = w.categories.map(c=> c===old ? name : c);
        }
      });
      state.categories[i] = name;
      if(state.ui.catFilter===old) state.ui.catFilter = name;
      saveState();
      renderCatsList(); render();
    });
  });
  // ä¸¦ã¹æ›¿ãˆ
  catsList.querySelectorAll("[data-up]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.up; if(i<=0) return;
      [state.categories[i-1], state.categories[i]] = [state.categories[i], state.categories[i-1]];
      saveState(); renderCatsList(); render();
    };
  });
  catsList.querySelectorAll("[data-down]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.down; if(i>=state.categories.length-1) return;
      [state.categories[i+1], state.categories[i]] = [state.categories[i], state.categories[i+1]];
      saveState(); renderCatsList(); render();
    };
  });
  // å‰Šé™¤
  catsList.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.del;
      if(state.categories.length<=1){ alert("ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯æœ€ä½1ã¤å¿…è¦ã§ã™"); return; }
      const delName = state.categories[i];
      if(!confirm(`ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€Œ${delName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯å„å˜èªã‹ã‚‰å¤–ã‚Œã¾ã™ã€‚`)) return;
      state.words.forEach(w=>{
        if(Array.isArray(w.categories)){
          w.categories = w.categories.filter(c=>c!==delName);
          if(w.categories.length===0) w.categories=["æœªåˆ†é¡"];
        }
      });
      if(state.ui.catFilter===delName) state.ui.catFilter="__all";
      state.categories.splice(i,1);
      saveState(); renderCatsList(); render();
    };
  });
}
addCatReal.addEventListener("click", ()=>{
  const name = newCatName.value.trim();
  if(!name) return;
  if(state.categories.includes(name)){ alert("åŒåã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒå­˜åœ¨ã—ã¾ã™"); return; }
  state.categories.push(name);
  newCatName.value="";
  saveState(); renderCatsList(); render();
});

/*** éŸ³å£° ***/
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    const en = voices.find(v=>/en-|English/i.test(v.lang||v.name||""));
    if(en) u.voice = en;
    u.lang = "en-US";
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch{ alert("éŸ³å£°å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"); }
}

/*** I/O ***/
$exportBtn.addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "vocab-board.json";
  a.click(); URL.revokeObjectURL(a.href);
});
$importInput.addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data.levels) || !Array.isArray(data.words)) throw new Error();
    if(!Array.isArray(data.categories)) data.categories = ["æœªåˆ†é¡","åè©","å‹•è©","å½¢å®¹è©","å‰¯è©","ã‚¤ãƒ‡ã‚£ã‚ªãƒ "];
    data.words.forEach(w=>{
      if(!Array.isArray(w.categories)) w.categories=["æœªåˆ†é¡"];
      if(!Array.isArray(w.relatedIds)) w.relatedIds=[];
    });
    state = Object.assign({ui:{selectedLevel:"Lv1", viewMode:"both", catFilter:"__all", autoRelate:true}}, data);
    autoRelateAll();
    render();
    alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
  }catch{ alert("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
  e.target.value="";
});
$resetBtn.addEventListener("click", ()=>{
  if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    state = {
      levels:["Lv1","Lv2","Lv3","Lv4"],
      categories:["æœªåˆ†é¡","åè©","å‹•è©","å½¢å®¹è©","å‰¯è©","ã‚¤ãƒ‡ã‚£ã‚ªãƒ "],
      words:[],
      ui:{selectedLevel:"Lv1", viewMode:"both", catFilter:"__all", autoRelate:true}
    };
    render();
  }
});

/*** ã‚¤ãƒ™ãƒ³ãƒˆ ***/
$addWordBtn.addEventListener("click", openAdd);
$manageLevelsBtn.addEventListener("click", openLevels);
$manageCatsBtn.addEventListener("click", openCats);
$search.addEventListener("input", render);
$levelSelect.addEventListener("change", ()=>{ state.ui.selectedLevel = $levelSelect.value; render(); });
$catFilter.addEventListener("change", ()=>{ state.ui.catFilter = $catFilter.value; render(); });
$viewMode.addEventListener("change", ()=>{ state.ui.viewMode = $viewMode.value; render(); });

/*** ã‚ªãƒ¼ãƒˆé–¢é€£ï¼ˆå®Œå…¨è‡ªå‹•ï¼‰ ***/
function norm(s){ return (s||"").toLowerCase().replace(/[^a-z]/g,""); }
function stemLitePlus(s){
  s = norm(s);
  if (s.length <= 3) return s;
  const rules = [
    /ability$|ibility$/,'',
    /ization$|isation$/,'',
    /fulness$/,'',
    /ousness$/,'',
    /ment$|ness$|less$|ship$|hood$|tion$|sion$|ance$|ence$|ery$|ary$/,'',
    /ingly$|edly$|ively$|ically$|ially$|ally$|ably$|ibly$|ily$/,'',
    /ational$|tional$|alize$|icate$|iciti$|ical$|ness$|ful$/,'',
    /ed$|ing$|ers$|ies$|es$|s$/,'',
    /able$|ible$|al$|ly$|er$|est$/,''
  ];
  for (let i=0; i<rules.length; i+=2){
    const r = rules[i], rep = rules[i+1];
    if (r.test(s)) { s = s.replace(r, rep); }
  }
  return s || s;
}
function familyKey(term){
  const st = stemLitePlus(term);
  if (st.length >= 3) return st;
  return norm(term);
}
function commonPrefix(a,b){
  a = String(a||""); b = String(b||"");
  let i=0; const L = Math.min(a.length, b.length);
  while(i<L && a[i]===b[i]) i++;
  return a.slice(0,i);
}
function autoRelateAll(){
  if (!state.ui.autoRelate) return;
  const bucket = new Map(); // key -> ids[]
  for (const w of state.words){
    const key = familyKey(w.term);
    if(!bucket.has(key)) bucket.set(key, []);
    bucket.get(key).push(w.id);
  }
  // è¿‘ç¸ã‚­ãƒ¼ã‚’ãƒãƒ¼ã‚¸ï¼ˆå…±é€šprefix>=4ï¼‰
  const arr = Array.from(bucket.entries());
  for(let i=0;i<arr.length;i++){
    for(let j=i+1;j<arr.length;j++){
      const [k1] = arr[i], [k2] = arr[j];
      if(!bucket.has(k1) || !bucket.has(k2)) continue;
      const pre = commonPrefix(k1,k2);
      if(pre.length >= 4){
        const moved = bucket.get(k2);
        bucket.get(k1).push(...moved);
        bucket.delete(k2);
      }
    }
  }
  const nextRelated = new Map(); // id -> Set<id>
  for(const [, ids] of bucket){
    const uniq = Array.from(new Set(ids));
    for(const id of uniq){
      if(!nextRelated.has(id)) nextRelated.set(id, new Set());
      for(const other of uniq){ if(other!==id) nextRelated.get(id).add(other); }
    }
  }
  const CAP = 12;
  const choose = id => {
    const s = nextRelated.get(id) || new Set();
    const sorted = Array.from(s).sort((a,b)=> (byId(b)?.createdAt||0) - (byId(a)?.createdAt||0)).slice(0, CAP);
    return sorted;
  };
  state.words.forEach(w=> w.relatedIds=[]);
  state.words.forEach(w=> { w.relatedIds = choose(w.id); });
  // åŒæ–¹å‘æ‹…ä¿
  for(const w of state.words){
    for(const rid of w.relatedIds){
      const ow = byId(rid); if(!ow) continue;
      if(!Array.isArray(ow.relatedIds)) ow.relatedIds=[];
      if(!ow.relatedIds.includes(w.id)) ow.relatedIds.push(w.id);
    }
  }
  saveState();
}

/*** åˆæœŸæç”» & åˆå›é–¢é€£ç”Ÿæˆ ***/
render();
autoRelateAll();
render();

// Safariå¯¾ç­–ï¼šéŸ³å£°voicesãŒé…å»¶ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã‚ã‚‹
if (window.speechSynthesis){ window.speechSynthesis.onvoiceschanged = ()=>{}; }
</script>
</body>
</html>
