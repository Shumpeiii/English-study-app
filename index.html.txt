<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è‹±å˜èªãƒœãƒ¼ãƒ‰ï¼ˆLvåˆ‡æ›¿ï¼‹è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#fff; --text:#111; --sub:#666;
    --border:#e6e6e9; --accent:#0f172a; --danger:#a20000;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text);}
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px); background:rgba(255,255,255,.85); border-bottom:1px solid var(--border);}
  .container{max-width:980px; margin:0 auto; padding:12px 16px;}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .title{font-weight:700}
  .grow{flex:1 1 auto}
  input[type="text"], select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff;}
  button, .btn{border:1px solid var(--border); background:#fff; padding:9px 12px; border-radius:12px; cursor:pointer;}
  .btn-accent{background:var(--accent); color:#fff; border-color:var(--accent)}
  .btn-danger{border-color:#f1c5c5; color:var(--danger); background:#fff5f5}
  .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--sub); background:#fff}
  main{padding:16px}
  .level-box{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden;}
  .level-head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:#fff;}
  .list{max-height:70vh; overflow:auto; padding:8px 8px 12px}
  .card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; margin:8px 2px; box-shadow:0 1px 0 rgba(0,0,0,.03);}
  .term{font-weight:700}
  .mean{color:var(--sub); font-size:13px}
  .empty{color:#999; text-align:center; padding:20px}
  dialog{border:none; border-radius:16px; width:min(560px, 92vw); padding:0; box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .modal-body{padding:16px}
  .modal-foot{display:flex; gap:8px; padding:12px 16px; border-top:1px solid var(--border); background:#fafafa; border-radius:0 0 16px 16px}
  .field{margin:10px 0}
  label{display:block; font-size:12px; color:#666; margin:6px 0}
  textarea{width:100%; min-height:86px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; resize:vertical; background:#fff}
  .toolbar{display:flex; flex-wrap:wrap; gap:8px}
  .muted{color:#777; font-size:12px}
</style>
</head>
<body>
<header>
  <div class="container row">
    <div class="title">è‹±å˜èªãƒœãƒ¼ãƒ‰</div>
    <div class="grow"></div>

    <!-- ãƒ¬ãƒ™ãƒ«é¸æŠ -->
    <select id="levelSelect" style="min-width:110px"></select>

    <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
    <select id="viewMode" title="è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰" style="min-width:125px">
      <option value="en">è‹±èªã®ã¿</option>
      <option value="ja">æ—¥æœ¬èªã®ã¿</option>
      <option value="both">ä¸¡æ–¹</option>
    </select>

    <input id="search" type="text" placeholder="æ¤œç´¢ï¼ˆè‹±èª / æ—¥æœ¬èªï¼‰" />
    <button id="addWordBtn" class="btn-accent">ï¼‹ è¿½åŠ </button>
    <button id="manageLevelsBtn">ãƒ¬ãƒ™ãƒ«ç®¡ç†</button>
    <button id="exportBtn">æ›¸ãå‡ºã—</button>
    <label class="btn">
      èª­ã¿è¾¼ã¿<input id="importInput" type="file" accept="application/json" hidden />
    </label>
    <button id="resetBtn" class="btn-danger">å…¨æ¶ˆå»</button>
  </div>
</header>

<main class="container">
  <section class="level-box">
    <div class="level-head">
      <div id="levelTitle" class="title">Lv</div>
      <div class="grow"></div>
      <span id="countPill" class="pill"></span>
    </div>
    <div id="list" class="list"></div>
  </section>
  <div class="muted" style="margin-top:10px;">å˜èªã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ï¼ˆæ„å‘³ãƒ»ä¾‹æ–‡ãƒ»èª­ã¿ä¸Šã’ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ãƒ¬ãƒ™ãƒ«å¤‰æ›´ï¼‰ã€‚</div>
</main>

<!-- è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="wordDlg">
  <form method="dialog">
    <div class="modal-body">
      <h3 id="wordDlgTitle" style="margin:4px 0 8px 0">å˜èªã‚’è¿½åŠ </h3>
      <div class="field">
        <label>è‹±å˜èª</label>
        <input id="fTerm" type="text" required />
      </div>
      <div class="field">
        <label>æ—¥æœ¬èªã®æ„å‘³</label>
        <input id="fMeaning" type="text" required />
      </div>
      <div class="field">
        <label>ä¾‹æ–‡ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="fExample" placeholder="ä¾‹ï¼‰I had an apple for breakfast."></textarea>
      </div>
      <div class="field">
        <label>ãƒ¬ãƒ™ãƒ«</label>
        <select id="fLevel"></select>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-accent">ä¿å­˜</button>
      <button type="button" id="wordDlgCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </form>
</dialog>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="detailDlg">
  <div class="modal-body">
    <div class="toolbar">
      <span id="dTerm" class="title" style="font-size:20px"></span>
      <button id="speakBtn" title="ç™ºéŸ³">ğŸ”Š</button>
      <span class="pill" id="dLevelPill"></span>
    </div>
    <div style="margin-top:6px">
      <div><strong>æ„å‘³ï¼š</strong><span id="dMeaning"></span></div>
      <div id="dExampleWrap" style="margin-top:6px; display:none;"><strong>ä¾‹æ–‡ï¼š</strong><div id="dExample" style="white-space:pre-wrap"></div></div>
    </div>

    <div class="field" style="margin-top:14px">
      <label>ãƒ¬ãƒ™ãƒ«å¤‰æ›´</label>
      <select id="dLevelSel"></select>
    </div>

    <div class="toolbar" style="margin-top:8px">
      <button id="editBtn">ç·¨é›†</button>
      <button id="deleteBtn" class="btn-danger">å‰Šé™¤</button>
      <div class="grow"></div>
      <button id="detailClose">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</dialog>

<!-- ãƒ¬ãƒ™ãƒ«ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="levelsDlg">
  <form method="dialog">
    <div class="modal-body">
      <h3 style="margin:4px 0 8px 0">ãƒ¬ãƒ™ãƒ«ç®¡ç†</h3>
      <div id="levelsList"></div>
      <div class="row" style="margin-top:10px">
        <input id="newLevelName" type="text" placeholder="æ–°ã—ã„ãƒ¬ãƒ™ãƒ«åï¼ˆä¾‹ï¼šLv5ï¼‰" />
        <button type="button" id="addLevelReal">ï¼‹ è¿½åŠ </button>
      </div>
      <div class="muted" style="margin-top:8px">ãƒ¬ãƒ™ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ãã®ãƒ¬ãƒ™ãƒ«ã®å˜èªã¯å…ˆé ­ãƒ¬ãƒ™ãƒ«ã¸ç§»å‹•ã—ã¾ã™ã€‚</div>
    </div>
    <div class="modal-foot">
      <button class="btn-accent">é–‰ã˜ã‚‹</button>
    </div>
  </form>
</dialog>

<script>
/*** ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ***/
const LS_KEY = "vocab_board_v2";
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"null"); }catch{ return null; } }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

/*** çŠ¶æ…‹ ***/
let state = loadState() || {
  levels: ["Lv1","Lv2","Lv3","Lv4"],
  words: [], // {id, term, meaning, example?, levelName, createdAt}
  ui: { selectedLevel: "Lv1", viewMode: "both" } // è¿½åŠ 
};

const byId = (id)=> state.words.find(w=>w.id===id);

/*** å‚ç…§ ***/
const $levelSelect = document.getElementById("levelSelect");
const $viewMode = document.getElementById("viewMode");
const $levelTitle = document.getElementById("levelTitle");
const $countPill = document.getElementById("countPill");
const $list = document.getElementById("list");

const $search = document.getElementById("search");
const $addWordBtn = document.getElementById("addWordBtn");
const $manageLevelsBtn = document.getElementById("manageLevelsBtn");
const $exportBtn = document.getElementById("exportBtn");
const $importInput = document.getElementById("importInput");
const $resetBtn = document.getElementById("resetBtn");

/*** åˆæœŸåŒ–ï¼ˆUIåæ˜ ï¼‰ ***/
function initSelectors(){
  // level select
  $levelSelect.innerHTML = "";
  state.levels.forEach(lv=>{
    const opt = document.createElement("option");
    opt.value = lv; opt.textContent = lv;
    $levelSelect.appendChild(opt);
  });
  if(!state.levels.includes(state.ui.selectedLevel)) state.ui.selectedLevel = state.levels[0];
  $levelSelect.value = state.ui.selectedLevel;

  // view mode
  $viewMode.value = state.ui.viewMode || "both";
}

/*** æç”» ***/
function render(){
  initSelectors();
  const lv = state.ui.selectedLevel;
  const mode = state.ui.viewMode;
  const q = $search.value.trim().toLowerCase();

  // ã‚¿ã‚¤ãƒˆãƒ« & ä»¶æ•°
  $levelTitle.textContent = lv;
  const items = state.words
    .filter(w=>w.levelName===lv)
    .filter(w=>{
      if(!q) return true;
      return w.term.toLowerCase().includes(q) || (w.meaning||"").toLowerCase().includes(q);
    })
    .sort((a,b)=> b.createdAt - a.createdAt);

  $countPill.textContent = `${items.length}èª`;

  // ãƒªã‚¹ãƒˆ
  $list.innerHTML = "";
  if(items.length===0){
    const empty = document.createElement("div");
    empty.className = "empty";
    empty.textContent = "å˜èªãŒã‚ã‚Šã¾ã›ã‚“";
    $list.appendChild(empty);
  }else{
    for(const w of items){
      const card = document.createElement("div");
      card.className = "card";

      // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®æœ¬æ–‡
      let inner = "";
      if(mode==="en"){
        inner = `<div class="term">${escapeHtml(w.term)}</div>`;
      }else if(mode==="ja"){
        inner = `<div class="term">${escapeHtml(w.meaning)}</div>`;
      }else{
        inner = `<div class="term">${escapeHtml(w.term)}</div><div class="mean">${escapeHtml(w.meaning)}</div>`;
      }
      card.innerHTML = inner;

      card.addEventListener("click", ()=> openDetail(w.id));
      $list.appendChild(card);
    }
  }

  saveState();
}

function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])) }

/*** è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ***/
const wordDlg = document.getElementById("wordDlg");
const wordDlgTitle = document.getElementById("wordDlgTitle");
const fTerm = document.getElementById("fTerm");
const fMeaning = document.getElementById("fMeaning");
const fExample = document.getElementById("fExample");
const fLevel = document.getElementById("fLevel");
const wordDlgCancel = document.getElementById("wordDlgCancel");
let editingId = null;

function populateLevelOptions(sel){
  sel.innerHTML = "";
  state.levels.forEach(lv=>{
    const opt = document.createElement("option");
    opt.value = lv; opt.textContent = lv;
    sel.appendChild(opt);
  });
}

function openAdd(){
  wordDlgTitle.textContent = "å˜èªã‚’è¿½åŠ ";
  populateLevelOptions(fLevel);
  fTerm.value = ""; fMeaning.value = ""; fExample.value = "";
  fLevel.value = state.ui.selectedLevel || state.levels[0] || "Lv1";
  editingId = null;
  wordDlg.showModal(); setTimeout(()=>fTerm.focus(),50);
}
function openEdit(id){
  const w = byId(id); if(!w) return;
  wordDlgTitle.textContent = "å˜èªã‚’ç·¨é›†";
  populateLevelOptions(fLevel);
  fTerm.value = w.term; fMeaning.value = w.meaning || ""; fExample.value = w.example || "";
  fLevel.value = w.levelName;
  editingId = id;
  wordDlg.showModal();
}

wordDlg.addEventListener("close", ()=>{
  if(wordDlg.returnValue==="cancel") return;
  const term = fTerm.value.trim();
  const meaning = fMeaning.value.trim();
  if(!term || !meaning) return;
  const example = fExample.value.trim();
  const levelName = fLevel.value;

  if(editingId){
    Object.assign(byId(editingId), {term, meaning, example: example || undefined, levelName});
  }else{
    state.words.unshift({ id: crypto.randomUUID(), term, meaning, example: example || undefined, levelName, createdAt: Date.now() });
  }
  render();
});
wordDlgCancel.addEventListener("click", ()=>{ wordDlg.returnValue="cancel"; wordDlg.close(); });

/*** è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ***/
const detailDlg = document.getElementById("detailDlg");
const dTerm = document.getElementById("dTerm");
const dMeaning = document.getElementById("dMeaning");
const dExampleWrap = document.getElementById("dExampleWrap");
const dExample = document.getElementById("dExample");
const dLevelPill = document.getElementById("dLevelPill");
const dLevelSel = document.getElementById("dLevelSel");
const deleteBtn = document.getElementById("deleteBtn");
const editBtn = document.getElementById("editBtn");
const detailClose = document.getElementById("detailClose");
const speakBtn = document.getElementById("speakBtn");
let currentDetailId = null;

function openDetail(id){
  const w = byId(id); if(!w) return;
  currentDetailId = id;
  dTerm.textContent = w.term;
  dMeaning.textContent = w.meaning || "";
  if(w.example){ dExampleWrap.style.display="block"; dExample.textContent = w.example; } else { dExampleWrap.style.display="none"; }
  dLevelPill.textContent = w.levelName;
  populateLevelOptions(dLevelSel); dLevelSel.value = w.levelName;
  detailDlg.showModal();
}
dLevelSel.addEventListener("change", ()=>{
  const w = byId(currentDetailId); if(!w) return;
  w.levelName = dLevelSel.value;
  dLevelPill.textContent = w.levelName;
  state.ui.selectedLevel = w.levelName; // é¸æŠä¸­ã®ãƒ¬ãƒ™ãƒ«ã‚‚åˆã‚ã›ã‚‹ã¨åˆ†ã‹ã‚Šã‚„ã™ã„
  render();
});
deleteBtn.addEventListener("click", ()=>{
  const w = byId(currentDetailId); if(!w) return;
  if(confirm(`ã€Œ${w.term}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){
    state.words = state.words.filter(x=>x.id!==w.id);
    detailDlg.close(); render();
  }
});
editBtn.addEventListener("click", ()=>{
  const id = currentDetailId; detailDlg.close(); setTimeout(()=>openEdit(id),50);
});
detailClose.addEventListener("click", ()=> detailDlg.close());
speakBtn.addEventListener("click", ()=>{
  const w = byId(currentDetailId); if(!w) return;
  speak(w.term);
});

/*** ãƒ¬ãƒ™ãƒ«ç®¡ç† ***/
const levelsDlg = document.getElementById("levelsDlg");
const levelsList = document.getElementById("levelsList");
const newLevelName = document.getElementById("newLevelName");
const addLevelReal = document.getElementById("addLevelReal");

function openLevels(){ renderLevelsList(); levelsDlg.showModal(); }
function renderLevelsList(){
  levelsList.innerHTML = "";
  state.levels.forEach((lv, idx)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.style.margin = "8px 0";
    row.innerHTML = `
      <input type="text" value="${escapeHtml(lv)}" data-idx="${idx}" style="flex:1 1 auto" />
      <button data-up="${idx}">â†‘</button>
      <button data-down="${idx}">â†“</button>
      <button class="btn-danger" data-del="${idx}">å‰Šé™¤</button>
    `;
    levelsList.appendChild(row);
  });

  // åå‰å¤‰æ›´
  levelsList.querySelectorAll("input[type=text]").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const i = +inp.dataset.idx;
      const old = state.levels[i];
      const name = inp.value.trim() || old;
      state.words.forEach(w=>{ if(w.levelName===old) w.levelName = name; });
      state.levels[i] = name;
      if(state.ui.selectedLevel===old) state.ui.selectedLevel = name;
      render(); renderLevelsList();
    });
  });
  // ä¸¦ã¹æ›¿ãˆ
  levelsList.querySelectorAll("[data-up]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.up; if(i<=0) return;
      [state.levels[i-1], state.levels[i]] = [state.levels[i], state.levels[i-1]];
      render(); renderLevelsList();
    };
  });
  levelsList.querySelectorAll("[data-down]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.down; if(i>=state.levels.length-1) return;
      [state.levels[i+1], state.levels[i]] = [state.levels[i], state.levels[i+1]];
      render(); renderLevelsList();
    };
  });
  // å‰Šé™¤
  levelsList.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const i = +btn.dataset.del;
      if(state.levels.length<=1){ alert("ãƒ¬ãƒ™ãƒ«ã¯æœ€ä½1ã¤å¿…è¦ã§ã™"); return; }
      const delName = state.levels[i];
      if(!confirm(`ãƒ¬ãƒ™ãƒ«ã€Œ${delName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãã®ãƒ¬ãƒ™ãƒ«ã®å˜èªã¯å…ˆé ­ãƒ¬ãƒ™ãƒ«ã¸ç§»å‹•ã—ã¾ã™ã€‚`)) return;
      const fallback = state.levels[0 === i ? 1 : 0];
      state.words.forEach(w=>{ if(w.levelName===delName) w.levelName = fallback; });
      if(state.ui.selectedLevel===delName) state.ui.selectedLevel = fallback;
      state.levels.splice(i,1);
      render(); renderLevelsList();
    };
  });
}
addLevelReal.addEventListener("click", ()=>{
  const name = newLevelName.value.trim();
  if(!name) return;
  if(state.levels.includes(name)){ alert("åŒåãƒ¬ãƒ™ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"); return; }
  state.levels.push(name);
  newLevelName.value="";
  render(); renderLevelsList();
});

/*** éŸ³å£° ***/
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    const en = voices.find(v=>/en-|English/i.test(v.lang||v.name||""));
    if(en) u.voice = en;
    u.lang = "en-US";
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch{ alert("éŸ³å£°å†ç”Ÿã«å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"); }
}

/*** I/O ***/
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "vocab-board.json";
  a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById("importInput").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data.levels) || !Array.isArray(data.words)) throw new Error();
    state = Object.assign({ui:{selectedLevel:"Lv1", viewMode:"both"}}, data);
    render();
    alert("èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
  }catch{ alert("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
  e.target.value="";
});
document.getElementById("resetBtn").addEventListener("click", ()=>{
  if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    state = { levels:["Lv1","Lv2","Lv3","Lv4"], words:[], ui:{selectedLevel:"Lv1", viewMode:"both"} };
    render();
  }
});

/*** ã‚¤ãƒ™ãƒ³ãƒˆ ***/
document.getElementById("addWordBtn").addEventListener("click", openAdd);
document.getElementById("manageLevelsBtn").addEventListener("click", openLevels);
$search.addEventListener("input", render);
$levelSelect.addEventListener("change", ()=>{
  state.ui.selectedLevel = $levelSelect.value; render();
});
$viewMode.addEventListener("change", ()=>{
  state.ui.viewMode = $viewMode.value; render();
});

/*** è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ***/
document.getElementById("wordDlgCancel").addEventListener("click", ()=>{ wordDlg.returnValue="cancel"; wordDlg.close(); });

/*** è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ***/
document.getElementById("detailClose").addEventListener("click", ()=> detailDlg.close());

/*** åˆæœŸæç”» ***/
render();
// Safariå¯¾ç­–ï¼šéŸ³å£°voicesãŒé…å»¶ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã‚ã‚‹
if (window.speechSynthesis){ window.speechSynthesis.onvoiceschanged = ()=>{}; }
</script>
</body>
</html>
